---
interface Props {
  tipText?: string[]
  expanded?: boolean
}

const {
  tipText = ['è¿™æ˜¯ä¸€ä¸ªæç¤ºç»„ä»¶'],
  expanded = false,
} = Astro.props;
---

<style>
  .tip-wrapper {
    position: fixed !important;
    width: 40px;
    height: 40px;
    z-index: 1000 !important;
    pointer-events: none;
    transition: none !important;
    left: 32px;
    top: 32px;
    transform: none !important;
  }

  .tip-wrapper > * {
    pointer-events: auto;
  }

  /* æ— éœ€é¢å¤–çš„tip-floatingç±»ï¼Œå·²é»˜è®¤ä¸ºfixedå®šä½ */

  .tip-container {
    position: relative;
    z-index: 10;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .tip-ball {
    width: 40px;
    height: 40px;
    background-color: #f8e896;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 20;
    user-select: none;
  }

  .tip-ball:active {
    cursor: grabbing;
  }

  .tip-content {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 280px;
    background-color: #fffbe6;
    border-radius: 8px;
    padding: 16px;
    margin-top: 8px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 10;
    border: 1px solid #f8e896;
  }

  .tip-content::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-bottom-color: #f8e896;
  }

  .tip-content::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 7px solid transparent;
    border-bottom-color: #fffbe6;
    margin-bottom: -1px;
  }

  .tip-expanded .tip-content {
    opacity: 1;
    max-height: 200px;
  }

  .tip-fixed {
    position: fixed;
    z-index: 100;
  }


</style>

<div id="tip-component" class="tip-wrapper">
  <div class="tip-container" data-expanded={expanded}>
    <div id="tip-drag-handle" class="tip-ball">
      <span class="text-xl">ğŸ’¡</span>
    </div>
    <div class="tip-content">
      <ul>
        {tipText.map(item => (
          <li>{item}</li>
        ))}
      </ul>
    </div>
  </div>
</div>

<script>
// åˆå§‹åŒ–ç»„ä»¶å¹¶æ·»åŠ äº¤äº’åŠŸèƒ½
function initializeTipComponent() {
  const tipComponent = document.getElementById('tip-component')
  if (!tipComponent)
    return

  // ç¡®ä¿ç»„ä»¶åœ¨document.bodyä¸­
  if (tipComponent.parentElement !== document.body) {
    document.body.appendChild(tipComponent)
  }

  const tipContainer = tipComponent.querySelector('.tip-container')
  const dragHandle = document.getElementById('tip-drag-handle')

  if (!tipContainer || !dragHandle)
    return

  let isDragging = false

  // ç¡®ä¿ç»„ä»¶å§‹ç»ˆæµ®äºå†…å®¹ä¸Šæ–¹
  tipComponent.style.transition = 'none !important'
  tipComponent.style.position = 'fixed'
  tipComponent.style.zIndex = '1000'

  // åˆå§‹åŒ–å±•å¼€çŠ¶æ€
  if (tipContainer && tipContainer.getAttribute('data-expanded') === 'true') {
    tipContainer.classList.add('tip-expanded')
  }

  // é˜»æ­¢æ–‡æœ¬é€‰ä¸­
  const preventTextSelection = (e: Event) => {
    if (isDragging) {
      e.preventDefault()
    }
  }

  document.addEventListener('selectstart', preventTextSelection)
  document.addEventListener('dragstart', preventTextSelection)

  // æç®€æ‹–æ‹½å®ç° - è§£å†³æ— æ³•ç§»åŠ¨åˆ°å·¦è¾¹çš„é—®é¢˜
  const handleDragStart = (e: MouseEvent) => {
    e.preventDefault() // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º

    // ç›´æ¥ä»æ ·å¼è·å–å½“å‰ä½ç½®ï¼Œç¡®ä¿èƒ½è¯»å–åˆ°æ­£ç¡®çš„å€¼
    const startLeft = Number.parseInt(tipComponent.style.left) || 32
    const startTop = Number.parseInt(tipComponent.style.top) || 32

    // è®°å½•é¼ æ ‡æŒ‰ä¸‹æ—¶çš„ä½ç½®
    const startMouseX = e.clientX
    const startMouseY = e.clientY

    isDragging = true

    // æ‹–æ‹½å¤„ç† - ç¡®ä¿å¯ä»¥ç§»åŠ¨åˆ°å·¦è¾¹
    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging)
        return

      // è®¡ç®—é¼ æ ‡ç§»åŠ¨çš„è·ç¦»
      const deltaX = e.clientX - startMouseX
      const deltaY = e.clientY - startMouseY

      // åŸºäºåˆå§‹ä½ç½®å’Œç§»åŠ¨è·ç¦»è®¡ç®—æ–°ä½ç½®
      let newLeft = startLeft + deltaX
      let newTop = startTop + deltaY

      // é™åˆ¶ç»„ä»¶åœ¨è§†å£å†… - å…è®¸ç§»åŠ¨åˆ°æœ€å·¦ä¾§
      const viewportWidth = window.innerWidth
      const viewportHeight = window.innerHeight
      const componentWidth = tipComponent.offsetWidth
      const componentHeight = tipComponent.offsetHeight

      // ä¿®å¤ï¼šå…è®¸ç§»åŠ¨åˆ°å·¦è¾¹ï¼ˆleft: 0ï¼‰
      newLeft = Math.max(0, Math.min(newLeft, viewportWidth - componentWidth))
      newTop = Math.max(0, Math.min(newTop, viewportHeight - componentHeight))

      // å¼ºåˆ¶åº”ç”¨fixedå®šä½ï¼Œé˜²æ­¢è¢«å…¶ä»–æ ·å¼è¦†ç›–
      tipComponent.style.position = 'fixed'
      tipComponent.style.zIndex = '1000'

      // ç›´æ¥è®¾ç½®ä½ç½®
      tipComponent.style.left = `${Math.round(newLeft)}px`
      tipComponent.style.top = `${Math.round(newTop)}px`
    }

    const handleMouseUp = () => {
      if (isDragging) {
        isDragging = false
        document.removeEventListener('mousemove', handleMouseMove)
        document.removeEventListener('mouseup', handleMouseUp)

        // é¼ æ ‡æ¾å¼€åå†æ¬¡ç¡®ä¿fixedå®šä½
        tipComponent.style.position = 'fixed'
        tipComponent.style.zIndex = '1000'
      }
    }

    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('mousemove', handleMouseMove)
    document.addEventListener('mouseup', handleMouseUp)
  }

  // ç‚¹å‡»å±•å¼€/æ”¶èµ·åŠŸèƒ½
  const handleClick = () => {
    if (isDragging)
      return

    const isExpanded = tipContainer.classList.contains('tip-expanded')

    if (!isExpanded) {
      tipContainer.classList.add('tip-expanded')
    }
    else {
      tipContainer.classList.remove('tip-expanded')
    }
  }

  // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®š
  dragHandle.removeEventListener('mousedown', handleDragStart)
  dragHandle.removeEventListener('click', handleClick)

  // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
  dragHandle.addEventListener('mousedown', handleDragStart)
  dragHandle.addEventListener('click', handleClick)
}

// ä½¿ç”¨astroç‰¹æœ‰çš„é¡µé¢åŠ è½½äº‹ä»¶ï¼Œç¡®ä¿åœ¨å®¢æˆ·ç«¯è·¯ç”±å¯¼èˆªæ—¶ä¹Ÿèƒ½æ­£ç¡®åˆå§‹åŒ–
function setupTipComponent() {
  // å°è¯•ç«‹å³åˆå§‹åŒ–
  initializeTipComponent()

  // åœ¨DOMContentLoadedæ—¶å†æ¬¡åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initializeTipComponent)

  // ä¸ºå®¢æˆ·ç«¯è·¯ç”±æ·»åŠ æ”¯æŒï¼ˆå¦‚æœä½¿ç”¨äº†Astroçš„å®¢æˆ·ç«¯è·¯ç”±ï¼‰
  document.addEventListener('astro:after-swap', initializeTipComponent)

  // é¡µé¢æ˜¾ç¤ºæ—¶ä¹Ÿé‡æ–°åˆå§‹åŒ–
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      initializeTipComponent()
    }
  })
}

// ç«‹å³æ‰§è¡Œè®¾ç½®
setupTipComponent()
</script>
